#!/usr/bin/env -S uv run --script
# /// script
# requires-python = ">=3.11"
# dependencies = ["typer", "rich"]
# ///
"""Delete ZFS snapshots older than a specified age."""

from __future__ import annotations

import re
import subprocess
from datetime import datetime, timedelta, timezone
from typing import Annotated, Optional

import typer
from rich.console import Console
from rich.prompt import Confirm
from rich.table import Table

console = Console(stderr=True)

app = typer.Typer(
    name="zfs-snapshot-cleanup",
    help="Delete ZFS snapshots older than a specified age.",
    no_args_is_help=True,
    add_completion=False,
)

_AGE_RE = re.compile(r"^(\d+)(mo|m|h|d|w|y)$")
_DATE_RE = re.compile(r"^\d{4}-\d{2}-\d{2}$")


def parse_age(age_str: str) -> datetime:
    """Parse a flexible age string into a UTC cutoff datetime.

    Accepts:
      - Duration suffixes: 30m, 4h, 7d, 2w, 3mo, 1y
      - Absolute date:     YYYY-MM-DD
    """
    now = datetime.now(tz=timezone.utc)

    if _DATE_RE.match(age_str):
        try:
            return datetime.strptime(age_str, "%Y-%m-%d").replace(tzinfo=timezone.utc)
        except ValueError:
            console.print(f"[red][X][/red] Invalid date: [bold]{age_str!r}[/bold] (expected YYYY-MM-DD)")
            raise typer.Exit(1)

    m = _AGE_RE.match(age_str)
    if not m:
        console.print(
            f"[red][X][/red] Invalid age: [bold]{age_str!r}[/bold]. "
            "Use <N>(m|h|d|w|mo|y), e.g. [bold]30m[/bold], [bold]4h[/bold], "
            "[bold]7d[/bold], [bold]2w[/bold], [bold]3mo[/bold], [bold]1y[/bold]"
        )
        raise typer.Exit(1)

    value, unit = int(m.group(1)), m.group(2)
    delta_map: dict[str, timedelta] = {
        "m":  timedelta(minutes=value),
        "h":  timedelta(hours=value),
        "d":  timedelta(days=value),
        "w":  timedelta(weeks=value),
        "mo": timedelta(days=value * 30),
        "y":  timedelta(days=value * 365),
    }
    return now - delta_map[unit]


def zfs_prefix(remote: Optional[str]) -> list[str]:
    """Return an SSH prefix list for remote execution, or empty for local."""
    return ["ssh", remote] if remote else []


def list_snapshots(
    pool: Optional[str],
    remote: Optional[str],
) -> list[tuple[str, datetime, int]]:
    """Query ZFS and return (name, creation_utc, used_bytes) for every snapshot."""
    cmd = zfs_prefix(remote) + [
        "zfs", "list",
        "-t", "snapshot",
        "-H",        # no header, tab-separated output
        "-p",        # parseable: timestamps as Unix epoch, sizes as raw bytes
        "-o", "name,creation,used",
    ]
    if pool and pool not in ("-", "all"):
        cmd += ["-r", pool]

    result = subprocess.run(cmd, capture_output=True, text=True)
    if result.returncode != 0:
        msg = result.stderr.strip() or "unknown error"
        console.print(f"[red][X][/red] zfs list failed: {msg}")
        raise typer.Exit(1)

    snapshots: list[tuple[str, datetime, int]] = []
    for line in result.stdout.splitlines():
        line = line.strip()
        if not line:
            continue
        parts = line.split("\t")
        if len(parts) != 3:
            continue
        name, creation_raw, used_raw = parts
        try:
            creation = datetime.fromtimestamp(int(creation_raw), tz=timezone.utc)
            used = int(used_raw)
        except ValueError:
            console.print(f"[yellow][!][/yellow] Could not parse data for snapshot: [dim]{name}[/dim]")
            continue
        snapshots.append((name, creation, used))

    return snapshots


def format_bytes(n: int) -> str:
    for unit, threshold in [("TiB", 2**40), ("GiB", 2**30), ("MiB", 2**20), ("KiB", 2**10)]:
        if n >= threshold:
            return f"{n / threshold:.2f} {unit}"
    return f"{n} B"


def display_table(snapshots: list[tuple[str, datetime, int]], show_space: bool) -> None:
    table = Table(show_header=True, header_style="bold cyan", show_edge=False, pad_edge=False)
    table.add_column("Snapshot", style="white", no_wrap=False, min_width=30)
    table.add_column("Created", style="dim", min_width=16)
    if show_space:
        table.add_column("Used", style="yellow", justify="right")

    for name, creation, used in snapshots:
        created_str = creation.strftime("%Y-%m-%d %H:%M")
        if show_space:
            table.add_row(name, created_str, format_bytes(used))
        else:
            table.add_row(name, created_str)

    console.print(table)

    if show_space:
        total = sum(u for _, _, u in snapshots)
        console.print(
            f"\n  [cyan][~][/cyan] Total space that would be freed: "
            f"[yellow bold]{format_bytes(total)}[/yellow bold]"
        )

    console.print()


def destroy_snapshots(snapshots: list[tuple[str, datetime, int]], remote: Optional[str]) -> None:
    deleted = 0
    failed = 0

    for name, _, _ in snapshots:
        cmd = zfs_prefix(remote) + ["zfs", "destroy", name]
        result = subprocess.run(cmd, capture_output=True, text=True)
        if result.returncode == 0:
            console.print(f"  [green]✓[/green] Deleted: {name}")
            deleted += 1
        else:
            err = result.stderr.strip() or "unknown error"
            console.print(f"  [red][X][/red] Failed: {name} — {err}")
            failed += 1

    console.print()
    if failed == 0:
        console.print(f"[green]Successfully deleted {deleted} snapshot(s)[/green]")
    else:
        console.print(f"[yellow][!][/yellow] Deleted {deleted} snapshot(s), {failed} failed")
        raise typer.Exit(1)


@app.command()
def main(
    pool: Annotated[
        str,
        typer.Argument(
            help='Pool or dataset to target. Use [bold]-[/bold] or [bold]all[/bold] for all pools.',
            show_default=False,
        ),
    ],
    age: Annotated[
        str,
        typer.Argument(
            help="Age threshold: [bold]30m[/bold], [bold]4h[/bold], [bold]7d[/bold], "
                 "[bold]2w[/bold], [bold]3mo[/bold], [bold]1y[/bold], or [bold]YYYY-MM-DD[/bold]",
            show_default=False,
        ),
    ],
    execute: Annotated[
        bool,
        typer.Option(
            "--execute", "--force",
            help="Actually destroy snapshots. Default is dry-run.",
        ),
    ] = False,
    yes: Annotated[
        bool,
        typer.Option("--yes", "-y", help="Skip confirmation prompt."),
    ] = False,
    no_space: Annotated[
        bool,
        typer.Option("--no-space", help="Skip used-space reporting."),
    ] = False,
    remote: Annotated[
        Optional[str],
        typer.Option(
            "--remote", "-r",
            help="SSH host to run zfs commands on.",
            metavar="HOST",
        ),
    ] = None,
) -> None:
    cutoff = parse_age(age)
    pool_display = pool if pool not in ("-", "all") else "(all pools)"

    console.print(
        f"  [blue][i][/blue] Cutoff:       [bold]{cutoff.strftime('%Y-%m-%d %H:%M:%S UTC')}[/bold]"
    )
    console.print(f"  [blue][i][/blue] Pool/Dataset: [bold]{pool_display}[/bold]")
    if remote:
        console.print(f"  [blue][i][/blue] Remote host:  [bold]{remote}[/bold]")
    console.print()

    all_snapshots = list_snapshots(pool, remote)
    candidates = [(n, c, u) for n, c, u in all_snapshots if c < cutoff]

    if not candidates:
        console.print(
            f"[green]No snapshots found older than "
            f"{cutoff.strftime('%Y-%m-%d %H:%M:%S UTC')}[/green]"
        )
        return

    console.print(
        f"  [cyan][~][/cyan] Found [bold]{len(candidates)}[/bold] snapshot(s) to delete:\n"
    )
    display_table(candidates, show_space=not no_space)

    if not execute:
        console.print(
            "[yellow][!][/yellow] [bold]DRY RUN MODE[/bold] — no snapshots will be deleted\n"
        )
        hint = ["zfs-snapshot-cleanup", pool, age]
        if remote:
            hint += ["--remote", remote]
        if no_space:
            hint.append("--no-space")
        if yes:
            hint.append("--yes")
        hint.append("--execute")
        console.print(f"  [dim]Run with [bold]--execute[/bold] to actually delete:[/dim]")
        console.print(f"  [dim]{' '.join(hint)}[/dim]")
        return

    console.print(
        f"[yellow][!][/yellow] About to delete [bold]{len(candidates)}[/bold] snapshot(s)"
    )
    if not yes:
        if not Confirm.ask("Continue?", default=False):
            console.print("[blue][i][/blue] Cancelled")
            return

    console.print()
    console.print("[blue][i][/blue] Deleting snapshots...\n")
    destroy_snapshots(candidates, remote)


if __name__ == "__main__":
    app()
