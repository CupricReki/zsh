#!/usr/bin/env bash
# Custom fzf installer
# Builds and installs fzf binary without modifying shell config

set -e

FZF_VERSION="${1:-master}"
INSTALL_DIR="${HOME}/.local/bin"
TMP_DIR="/tmp/fzf-install-$$"

echo "Installing fzf to ${INSTALL_DIR}..."

# Create install directory if it doesn't exist
mkdir -p "$INSTALL_DIR"

# Clone fzf repository to temp directory
echo "Cloning fzf repository..."
git clone --depth 1 https://github.com/junegunn/fzf.git "$TMP_DIR"
cd "$TMP_DIR"

# Build binary
echo "Building fzf binary..."
if command -v go &> /dev/null; then
    # Build from source if Go is available
    go build -o fzf
else
    # Download pre-built binary
    echo "Go not found, downloading pre-built binary..."
    
    # Detect OS and architecture
    OS=$(uname -s | tr '[:upper:]' '[:lower:]')
    ARCH=$(uname -m)
    
    case "$ARCH" in
        x86_64) ARCH="amd64" ;;
        aarch64|arm64) ARCH="arm64" ;;
        armv7l) ARCH="armv7" ;;
        *) echo "Unsupported architecture: $ARCH"; exit 1 ;;
    esac
    
    # Get latest release version
    LATEST_VERSION=$(curl -s https://api.github.com/repos/junegunn/fzf/releases/latest | grep -oP '"tag_name": "\K[^"]+')
    
    # Download binary
    DOWNLOAD_URL="https://github.com/junegunn/fzf/releases/download/${LATEST_VERSION}/fzf-${LATEST_VERSION}-${OS}_${ARCH}.tar.gz"
    echo "Downloading from: $DOWNLOAD_URL"
    
    curl -sL "$DOWNLOAD_URL" | tar xz
fi

# Install binary
echo "Installing binary to ${INSTALL_DIR}/fzf..."
cp fzf "$INSTALL_DIR/"
chmod +x "$INSTALL_DIR/fzf"

# Cleanup
cd /
rm -rf "$TMP_DIR"

echo ""
echo "âœ“ fzf installed successfully to ${INSTALL_DIR}/fzf"
echo ""
echo "Version: $(${INSTALL_DIR}/fzf --version)"
echo ""

# Check if install dir is in PATH
if [[ ":$PATH:" != *":${INSTALL_DIR}:"* ]]; then
    echo "NOTE: ${INSTALL_DIR} is not in your PATH"
    echo "Add this to your ~/.zshenv:"
    echo "  export PATH=\"\$HOME/.local/bin:\$PATH\""
    echo ""
fi

echo "fzf shell integration is already configured in your zshrc"
echo "Key bindings available: Ctrl+T, Ctrl+R, Alt+C"

