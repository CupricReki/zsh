#!/bin/bash
#
# split_and_tag.sh
# Splits a .flac album using a .cue file, removes pregap track00,
# and applies metadata using cuetag.sh.
#

set -euo pipefail

# --- Defaults ---
DIR="."
CUE_FILE=""
FLAC_FILE=""

# --- Functions ---

print_help() {
  cat <<EOF
🎶 split_and_tag.sh - FLAC album splitter and tagger

Usage:
  $(basename "$0") [-c cue_file] [-f flac_file] [directory]

Options:
  -c, --cue    Path to the .cue file to use
  -f, --flac   Path to the .flac file to split
  -h, --help   Show this help message

Arguments:
  directory    Optional path to directory containing the files (default: current)

If -c or -f are not provided, the script will auto-detect the only .cue and .flac
file in the specified directory. It will fail if more than one of either exists.

Example:
  ./split_and_tag.sh -c "album.cue" -f "album.flac" ~/Music/AlbumDir
  ./split_and_tag.sh ~/Music/AlbumDir
EOF
}

# --- Parse arguments ---

while [[ $# -gt 0 ]]; do
  case "$1" in
    -c|--cue)
      CUE_FILE="$2"
      shift 2
      ;;
    -f|--flac)
      FLAC_FILE="$2"
      shift 2
      ;;
    -h|--help)
      print_help
      exit 0
      ;;
    *)
      if [[ -z "$DIR" || "$DIR" == "." ]]; then
        DIR="$1"
        shift
      else
        echo "❌ Unknown argument or multiple directories specified: $1"
        exit 1
      fi
      ;;
  esac
done

# --- Validate directory ---
if [[ ! -d "$DIR" ]]; then
  echo "❌ Error: '$DIR' is not a valid directory."
  exit 1
fi

cd "$DIR"

# --- Auto-detect files if not provided ---
if [[ -z "$FLAC_FILE" ]]; then
  FLACS=( *.flac )
  if [[ ${#FLACS[@]} -ne 1 ]]; then
    echo "❌ Error: Expected exactly one .flac file. Found ${#FLACS[@]}."
    exit 1
  fi
  FLAC_FILE="${FLACS[0]}"
fi

if [[ -z "$CUE_FILE" ]]; then
  CUES=( *.cue )
  if [[ ${#CUES[@]} -ne 1 ]]; then
    echo "❌ Error: Expected exactly one .cue file. Found ${#CUES[@]}."
    exit 1
  fi
  CUE_FILE="${CUES[0]}"
fi

# --- Display ---
echo "📁 Directory: $DIR"
echo "🎧 FLAC:      $FLAC_FILE"
echo "📄 CUE:       $CUE_FILE"

# --- Split ---
echo "🔪 Splitting FLAC..."
shnsplit -f "$CUE_FILE" -t "%n - %t" -o flac "$FLAC_FILE"

# --- Remove pregap ---
if [[ -f split-track00.flac ]]; then
  echo "🗑️  Removing pregap: split-track00.flac"
  rm split-track00.flac
fi

# --- Tag files ---
if command -v cuetag.sh >/dev/null; then
  echo "🏷️  Applying tags..."
  cuetag.sh "$CUE_FILE" split-track*.flac
else
  echo "❌ Error: cuetag.sh not found in PATH"
  exit 2
fi

echo "✅ Done. Tracks split and tagged in '$DIR'"

