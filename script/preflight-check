#!/usr/bin/env zsh
# Preflight checks for zsh configuration
# Validates required tools and versions before loading config
# Note: log() function is available from zshenv

# ================================================
# Flags and State Files
# ================================================
# The following flags and files are used to control preflight check behavior:
#
# Environment Variables:
#   SKIP_PREFLIGHT_CHECK - If set to non-empty, disables all preflight checks
#     Usage: export SKIP_PREFLIGHT_CHECK=1
#
# Flag Files (in $ZSH_CACHE_DIR, typically ~/.cache/zsh/):
#   .skip-preflight-check - If this file exists, disables all preflight checks
#     Usage: touch $ZSH_CACHE_DIR/.skip-preflight-check
#
#   .first-run-complete - Created after first run to mark initialization as complete
#     - If missing: First run, auto-fix prompt will appear
#     - If exists: Not first run, only show warnings (no auto-fix prompt)
#
#   .preflight-failed-fixes - Stores list of tools that failed to install
#     - Created when auto-fix fails and user wants to retry
#     - Contains one tool name per line
#     - Checked on subsequent runs to offer retry if tools still missing
#     - Removed when all fixes succeed or user declines retry
#
# ================================================

# ================================================
# Requirements Check with Auto-Fix
# ================================================

# Check if preflight checks are disabled
# Note: Helper functions (file_exists) are available from zshenv
_cache_dir="${ZSH_CACHE_DIR:-${XDG_CACHE_HOME:-$HOME/.cache}/zsh}"
_skip_check_flag="${_cache_dir}/.skip-preflight-check"
if [[ -n "$SKIP_PREFLIGHT_CHECK" ]] || file_exists "$_skip_check_flag"; then
  return 0
fi

# Check if this is first run ever (no flag file exists)
_first_run_flag="${_cache_dir}/.first-run-complete"
_failed_fixes_flag="${_cache_dir}/.preflight-failed-fixes"
_is_first_run=false

if ! file_exists "$_first_run_flag"; then
  _is_first_run=true
fi

# Preflight checks always run on every shell startup
# Auto-fix prompt only appears on first run ever

# Essential tools required for full functionality
# Format: "tool:description:fix_function"
_required_tools=(
  "git:git:false"
  "curl:curl:false"
  "fzf:fzf:install_fzf"
  "fd:fd:false"
  "cargo:cargo:install_cargo"
  "sheldon:sheldon:install_sheldon"
  "tree:tree:false"
)


# Version requirements (tool:min_version:fix_function)
_version_requirements=(
  "fzf:0.40.0:install_fzf"
  "zsh:5.8:false"
)

# Installation functions (called instead of eval)
install_fzf() {
  "${ZSCRIPTS}/install-fzf"
}

install_cargo() {
  curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh
}

install_sheldon() {
  # Check if cargo is available
  if ! command_exists cargo; then
    log error "cargo not found. Install rustup first: curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh"
    return 1
  fi
  cargo install sheldon
}

# Check for missing required tools
_missing_required=()
_fixable_missing=()

for tool_entry in "${_required_tools[@]}"; do
  IFS=':' read -r tool desc fix_cmd <<< "$tool_entry"
  if ! command_exists "$tool"; then
    _missing_required+=("  - $desc")
    if [[ "$fix_cmd" != "false" ]]; then
      _fixable_missing+=("$tool:$desc:$fix_cmd")
    fi
  fi
done

# Check versions for installed tools
_version_warnings=()
_fixable_versions=()

# Check fzf version
if command_exists fzf; then
  _fzf_version=$(fzf --version 2>/dev/null | cut -d' ' -f1)
  _fzf_min="0.40.0"

  # Validate version format
  if [[ -z "$_fzf_version" ]]; then
    _version_warnings+=("  - fzf version could not be determined")
  elif [[ ! "$_fzf_version" =~ ^[0-9]+\.[0-9]+(\.[0-9]+)? ]]; then
    _version_warnings+=("  - fzf version format is invalid: $_fzf_version")
  elif [[ "$(printf '%s\n' "$_fzf_min" "$_fzf_version" | sort -V | head -n1)" != "$_fzf_min" ]]; then
    _version_warnings+=("  - fzf $_fzf_version is older than recommended $_fzf_min")
    _fixable_versions+=("fzf:Upgrade fzf to $_fzf_min:install_fzf")
  fi
fi

# Check zsh version
_zsh_version="${ZSH_VERSION}"
_zsh_min="5.8"
if [[ -n "$_zsh_version" ]]; then
  if [[ "$(printf '%s\n' "$_zsh_min" "$_zsh_version" | sort -V | head -n1)" != "$_zsh_min" ]]; then
    _version_warnings+=("  - zsh $_zsh_version is older than required $_zsh_min")
    _version_warnings+=("    Manual upgrade required via package manager")
  fi
fi

# Always display warnings if issues exist (runs on every shell startup)
_has_issues=false
if [[ ${#_missing_required[@]} -gt 0 ]] || [[ ${#_version_warnings[@]} -gt 0 ]]; then
  _has_issues=true
  echo "" >&2

  if [[ ${#_missing_required[@]} -gt 0 ]]; then
    log warning "Missing required tools:"
    printf '%s\n' "${_missing_required[@]}" >&2
    echo "" >&2
  fi

  if [[ ${#_version_warnings[@]} -gt 0 ]]; then
    log warning "Version issues detected:"
    printf '%s\n' "${_version_warnings[@]}" >&2
    echo "" >&2
  fi

  # Only offer auto-fix on first run ever (or if previous fix failed and user wants retry)
  _should_offer_fix=false
  _failed_fixes=()

  if [[ "$_is_first_run" == "true" ]]; then
    _should_offer_fix=true
  elif file_exists "$_failed_fixes_flag"; then
    # Load list of previously failed fixes and check if any are still needed
    while IFS= read -r line; do
      _failed_fixes+=("$line")
    done < "$_failed_fixes_flag"

    # Check if any failed fixes are still needed (tools still missing)
    for failed_tool in "${_failed_fixes[@]}"; do
      if ! command_exists "$failed_tool"; then
        _should_offer_fix=true
        break
      fi
    done
  fi

  if [[ "$_should_offer_fix" == "true" ]]; then
  if [[ ${#_fixable_missing[@]} -gt 0 ]] || [[ ${#_fixable_versions[@]} -gt 0 ]]; then
    echo "Would you like to automatically fix these issues? (y/n)" >&2
    read -q "REPLY?> " >&2
    echo "" >&2

    if [[ $REPLY == "y" ]]; then
      echo "" >&2
      log info "Installing/updating tools..."
      echo "" >&2

      _new_failed_fixes=()

      # Fix missing tools
      for fix_entry in "${_fixable_missing[@]}"; do
        IFS=':' read -r tool desc fix_func <<< "$fix_entry"
        echo "Installing $desc..." >&2
        if "$fix_func"; then
          log success "$desc installed successfully"
        else
          log error "Failed to install $desc"
          _new_failed_fixes+=("$tool")
        fi
        echo "" >&2
      done

      # Fix version issues
      for fix_entry in "${_fixable_versions[@]}"; do
        IFS=':' read -r tool desc fix_func <<< "$fix_entry"
        echo "$desc..." >&2
        if "$fix_func"; then
          log success "$tool updated successfully"
        else
          log error "Failed to update $tool"
          _new_failed_fixes+=("$tool")
        fi
        echo "" >&2
      done

      # Handle failed fixes
      if [[ ${#_new_failed_fixes[@]} -gt 0 ]]; then
        log warning "Some installations failed."
        echo "Would you like to retry on next shell startup? (y/n)" >&2
        read -q "RETRY?> " >&2
        echo "" >&2

        if [[ $RETRY == "y" ]]; then
          # Save failed tools to retry file
          mkdir -p "$(dirname "$_failed_fixes_flag")"
          printf '%s\n' "${_new_failed_fixes[@]}" > "$_failed_fixes_flag"
          log info "Will prompt again on next startup."
        else
          # User doesn't want to retry
          rm -f "$_failed_fixes_flag"
          echo "" >&2
          log info "To disable preflight warnings completely:"
          echo "  export SKIP_PREFLIGHT_CHECK=1" >&2
          echo "Or: touch \$ZSH_CACHE_DIR/.skip-preflight-check" >&2
        fi
      else
        # All fixes succeeded, remove retry file
        rm -f "$_failed_fixes_flag"
        log success "Setup complete! Restart your shell: exec zsh"
      fi
      echo "" >&2
    else
      echo "" >&2
      log info "Skipped automatic fixes."
      echo "" >&2
      log info "To disable these warnings:"
      echo "  export SKIP_PREFLIGHT_CHECK=1" >&2
      echo "Or: touch \$ZSH_CACHE_DIR/.skip-preflight-check" >&2
      echo "" >&2
      log info "See README.md for manual installation instructions."
      echo "" >&2
    fi
  else
    log info "Manual installation required. See README.md for instructions."
    echo "" >&2
  fi
  else
    # Not first run, no retry needed, just show info
    log info "See README.md for installation instructions."
    echo "" >&2
    log info "To disable these warnings:"
    echo "  export SKIP_PREFLIGHT_CHECK=1" >&2
    echo "Or: touch \$ZSH_CACHE_DIR/.skip-preflight-check" >&2
    echo "" >&2
  fi
fi

# Mark first run as complete (whether fixed or not)
# Preflight checks will still run on every startup, but won't prompt for auto-fix
if [[ "$_is_first_run" == "true" ]]; then
  mkdir -p "$(dirname "$_first_run_flag")"
  touch "$_first_run_flag"
fi

# Cleanup
unset _cache_dir _skip_check_flag _first_run_flag _failed_fixes_flag _is_first_run _has_issues
unset _should_offer_fix _failed_fixes _new_failed_fixes
unset _required_tools _version_requirements _missing_required _version_warnings
unset _fixable_missing _fixable_versions
unset tool_entry tool desc fix_cmd fix_entry failed_tool REPLY RETRY
unset _fzf_version _fzf_min _zsh_version _zsh_min
